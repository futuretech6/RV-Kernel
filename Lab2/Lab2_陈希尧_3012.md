<center><font size=7>ã€Šæ“ä½œç³»ç»Ÿã€‹Lab2</font></center><br /><div align='right'><font size=4><b>é™ˆå¸Œå°§</b> 3180103012</font><br /><div align='right'><font size=4>Group17</font></div>

[TOC]

# Lab Basis

## Purpose

å­¦ä¹ RISC-Vç›¸å…³çŸ¥è¯†ï¼ŒMakeleç›¸å…³çŸ¥è¯†ï¼Œç¼–å†™head.Så®ç°bootloaderçš„åŠŸèƒ½ï¼Œå¹¶åˆ©ç”¨Makeleæ¥å®Œæˆå¯¹æ•´ä¸ªå·¥ç¨‹çš„ç®¡ç†ã€‚

## Environment

OS: Ubuntu 18.04.5 LTS on Windows 10 x86_64 (WSL2)

Kernel: 4.19.128-microsoft-standard

Docker version 19.03.13

## Lab Principle

### Trap

å¼‚å¸¸(trap)æ˜¯æŒ‡æ˜¯ä¸å¯»å¸¸çš„è¿è¡Œæ—¶äº‹ä»¶ï¼Œç”±ç¡¬ä»¶æˆ–è½¯ä»¶äº§ç”Ÿï¼Œå½“å¼‚å¸¸äº§ç”Ÿæ—¶æ§åˆ¶æƒå°†ä¼šè½¬ç§»è‡³å¼‚å¸¸å¤„ç†ç¨‹åºã€‚å¼‚å¸¸æ˜¯æ“ä½œç³»ç»Ÿæœ€åŸºç¡€çš„æ¦‚å¿µï¼Œä¸€ä¸ªæ²¡æœ‰å¼‚å¸¸çš„æ“ä½œç³»ç»Ÿæ— æ³•è¿›è¡Œæ­£å¸¸äº¤äº’ã€‚

RISC-Vå°†å¼‚å¸¸åˆ†ä¸ºä¸¤ç±»ã€‚ä¸€ç±»æ˜¯ç¡¬ä»¶ä¸­æ–­(interrupt)ï¼Œå®ƒæ˜¯ä¸æŒ‡ä»¤æµå¼‚æ­¥çš„å¤–éƒ¨äº‹ä»¶ï¼Œæ¯”å¦‚é¼ æ ‡çš„å•å‡»ã€‚å¦å¤–ä¸€ç±»æ˜¯åŒæ­¥å¼‚å¸¸(exception)ï¼Œè¿™ç±»å¼‚å¸¸åœ¨æŒ‡ä»¤æ‰§è¡ŒæœŸé—´äº§ç”Ÿï¼Œå¦‚è®¿é—®äº†æ— æ•ˆçš„å­˜å‚¨å™¨åœ°å€æˆ–æ‰§è¡Œäº†å…·æœ‰æ— æ•ˆæ“ä½œç çš„æŒ‡ä»¤æ—¶ã€‚

è¿™é‡Œæˆ‘ä»¬ç”¨å¼‚å¸¸(trap)ä½œä¸ºç¡¬ä»¶ä¸­æ–­(interrupt)å’ŒåŒæ­¥å¼‚å¸¸(exception)çš„é›†åˆï¼Œå¦å¤–trapæŒ‡çš„æ˜¯å‘ç”Ÿç¡¬ä»¶ä¸­æ–­æˆ–è€…åŒæ­¥å¼‚å¸¸æ—¶æ§åˆ¶æƒè½¬ç§»åˆ°handlerçš„è¿‡ç¨‹ã€‚

### Trap in M mode

#### å¼‚å¸¸éœ€è¦çš„å¯„å­˜å™¨

Machine modeå¼‚å¸¸éœ€è¦ä½¿ç”¨çš„å¯„å­˜å™¨é¦–å…ˆæœ‰lab1æåˆ°çš„mstatusï¼Œmipï¼Œmieï¼Œmtvecå¯„å­˜å™¨ï¼Œè¿™äº›å¯„å­˜å™¨éœ€è¦æˆ‘ ä»¬æ“ä½œï¼›å‰©ä¸‹è¿˜æœ‰mepcï¼Œmcauseå¯„å­˜å™¨ï¼Œè¿™äº›å¯„å­˜å™¨åœ¨å¼‚å¸¸å‘ç”Ÿæ—¶ç¡¬ä»¶ä¼šè‡ªåŠ¨ç½®ä½ï¼Œå®ƒä»¬çš„åŠŸèƒ½å¦‚ä¸‹ï¼š

* mepcï¼ˆMachine Exception Program Counterï¼‰ï¼šé€šå¸¸æŒ‡å‘å¼‚å¸¸å¤„ç†ååº”è¯¥æ¢å¤æ‰§è¡Œçš„ä½ç½®
* mcauseï¼ˆMachine Cause Registerï¼‰ï¼šä¿å­˜å¼‚å¸¸çš„ç§ç±»ï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹è¯·å‚è€ƒThe RISC-V Instruction Set Manual 3.1.16èŠ‚ï¼ˆP.40ï¼‰

äº‹å®ä¸Šï¼Œå¼‚å¸¸è¿˜ä¸midelegå’Œmedelegä¸¤ä¸ªå¯„å­˜å™¨å¯†åˆ‡ç›¸å…³ï¼Œå®ƒä»¬çš„åŠŸèƒ½å°†åœ¨Supervisor modeä¸‹çš„å¼‚å¸¸éƒ¨åˆ†è®² è§£ã€‚ ä¸æ—¶é’Ÿä¸­æ–­ç›¸å…³çš„è¿˜æœ‰mtimeå’Œmtimecmpå¯„å­˜å™¨ï¼Œå®ƒä»¬çš„åŠŸèƒ½å¦‚ä¸‹ï¼š 

* mtimeï¼ˆMachine Time Registerï¼‰ï¼šä¿å­˜æ—¶é’Ÿè®¡æ•°ï¼Œè¿™ä¸ªå€¼ä¼šç”±ç¡¬ä»¶è‡ªå¢ 
* mtimecmpï¼ˆMachine Time Compare Registerï¼‰ï¼šä¿å­˜éœ€è¦æ¯”è¾ƒçš„æ—¶é’Ÿè®¡æ•°ï¼Œå½“mtimeçš„å€¼å¤§äºæˆ–ç­‰äº mtimecmpçš„å€¼æ—¶ï¼Œæ—¶é’Ÿä¸­æ–­è§¦å‘

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œmtimeå’Œmtimecmpå¯„å­˜å™¨éœ€è¦ç”¨MMIOçš„æ–¹å¼å³ä½¿ç”¨å†…å­˜è®¿é—®æŒ‡ä»¤ï¼ˆsdï¼Œldç­‰ï¼‰çš„æ–¹å¼äº¤äº’ï¼Œå¯ä»¥å°†å®ƒä»¬ç†è§£ä¸ºMachine modeä¸‹çš„ä¸€ä¸ªå¤–è®¾ã€‚

#### ç¡¬ä»¶ä¸­æ–­çš„å¤„ç†ï¼ˆä»¥æ—¶é’Ÿä¸­æ–­ä¸ºä¾‹ï¼‰

ç®€å•åœ°æ¥è¯´ï¼Œä¸­æ–­å¤„ç†ç»è¿‡äº†ä¸‰ä¸ªæµç¨‹ï¼Œä¸­æ–­è§¦å‘ï¼Œåˆ¤æ–­å¯ä»¥å¤„ç†è¿˜æ˜¯å¿½ç•¥ï¼Œå¯ä»¥å¤„ç†æ—¶è°ƒç”¨å¤„ç†å‡½æ•°ã€‚

1. ä¸­æ–­è§¦å‘ï¼š æ—¶é’Ÿä¸­æ–­çš„è§¦å‘æ¡ä»¶æ˜¯è¿™ä¸ªhartï¼ˆç¡¬ä»¶çº¿ç¨‹ï¼‰çš„æ—¶é—´æ¯”è¾ƒå™¨mtimecmpå°äºå®æ•°è®¡æ•°å™¨mtimeã€‚
2. åˆ¤æ–­æ˜¯å¦å¯å¤„ç†ï¼šå½“æ—¶é’Ÿä¸­æ–­è§¦å‘æ—¶ï¼Œå¹¶ä¸ä¸€å®šä¼šå“åº”ä¸­æ–­ä¿¡å·ã€‚Machine modeåªæœ‰åœ¨å…¨å±€ä¸­æ–­ä½¿èƒ½ä½mstatus[mie]ç½®ä½æ—¶æ‰ä¼šäº§ç”Ÿä¸­æ–­ï¼Œå¦‚æœåœ¨Supervisor modeä¸‹è§¦å‘äº†Machine modeçš„ä¸­æ–­ï¼Œæ­¤æ—¶æ— è§†mstatus[mie]ç›´æ¥å“åº”ï¼Œå³è¿è¡Œåœ¨ä½æƒé™æ¨¡å¼ä¸‹ï¼Œé«˜æƒé™æ¨¡å¼çš„å…¨å±€ä¸­æ–­ä½¿èƒ½ä½ä¸€ç›´æ˜¯enableçŠ¶æ€ã€‚æ­¤å¤–ï¼Œæ¯ä¸ªä¸­æ–­åœ¨æ§åˆ¶çŠ¶æ€å¯„å­˜å™¨mieä¸­éƒ½æœ‰è‡ªå·±çš„ä½¿èƒ½ ä½ï¼Œå¯¹äºç‰¹å®šä¸­æ–­æ¥è¯´ï¼Œéœ€è¦è€ƒè™‘è‡ªå·±å¯¹åº”çš„ä½¿èƒ½ä½ï¼Œè€Œæ§åˆ¶çŠ¶æ€å¯„å­˜å™¨mipä¸­åˆæŒ‡ç¤ºç›®å‰å¾…å¤„ç†çš„ä¸­æ–­ã€‚ä»¥æ—¶é’Ÿä¸­æ–­ä¸ºä¾‹ï¼Œåªæœ‰å½“mstatus[mie]=1ï¼Œmie[mtie]=1ï¼Œä¸”mip[mtip]=1æ—¶ï¼Œæ‰å¯ä»¥å¤„ç†æœºå™¨çš„æ—¶é’Ÿä¸­æ–­ã€‚å…¶ä¸­mstatus[mie] ä»¥åŠmie[mtie]éœ€è¦æˆ‘ä»¬è‡ªå·±è®¾ç½®ï¼Œè€Œmip[mtip]åœ¨ä¸­æ–­è§¦å‘æ—¶ä¼šè¢«ç¡¬ä»¶è‡ªåŠ¨ç½®ä½ã€‚
3. è°ƒç”¨å¤„ç†å‡½æ•°ï¼š å½“æ»¡è¶³å¯¹åº”ä¸­æ–­çš„å¤„ç†æ¡ä»¶æ—¶ï¼Œç¡¬ä»¶é¦–å…ˆä¼šå‘ç”Ÿä¸€äº›çŠ¶æ€è½¬æ¢ï¼ˆå‚è€ƒä¸­æ–‡æ‰‹å†Œ10.3èŠ‚ï¼‰ï¼Œå¹¶è·³è½¬åˆ°å¯¹åº”çš„å¼‚å¸¸å¤„ç†å‡½æ•°ä¸­ï¼Œåœ¨å¼‚å¸¸å¤„ç†å‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†æå¼‚å¸¸äº§ç”Ÿçš„åŸå› åˆ¤æ–­å…·ä½“ä¸ºå“ªä¸€ç§ï¼Œç„¶åæ‰§è¡Œå¯¹åº”çš„å¤„ç†ã€‚ä¸ºäº†å¤„ç†å¼‚å¸¸ç»“æŸåä¸å½±å“hartæ­£å¸¸çš„è¿è¡ŒçŠ¶æ€ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ä¿å­˜å½“å‰çš„çŠ¶æ€å³ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚æˆ‘ä»¬å¯ä»¥å…ˆç”¨æ ˆä¸Šçš„ä¸€æ®µç©ºé—´ æ¥æŠŠå…¨éƒ¨å¯„å­˜å™¨ä¿å­˜ï¼Œä¿å­˜å®Œä¹‹åæ‰§è¡Œåˆ°æˆ‘ä»¬ç¼–å†™çš„å¼‚å¸¸å¤„ç†å‡½æ•°ä¸»ä½“ï¼Œç»“æŸåé€€å‡ºã€‚å‡½æ•°è°ƒç”¨è§„èŒƒå¯ä»¥å‚è€ƒä¸­æ–‡å¼€æºæ‰‹å†Œ3.2èŠ‚ã€‚

#### åŒæ­¥å¼‚å¸¸çš„å¤„ç†

åŒæ­¥å¼‚å¸¸çš„è§¦å‘æ¡ä»¶æ˜¯å½“å‰æŒ‡ä»¤æ‰§è¡Œäº†æœªç»å®šä¹‰çš„è¡Œä¸ºï¼Œæ¯”å¦‚Illegal instructionï¼Œä¹Ÿæ²¡æœ‰åˆ¤æ–­å¯ä»¥å¤„ç†è¿˜æ˜¯å¿½ç•¥ çš„æ­¥éª¤ï¼Œç¡¬ä»¶ä¼šç›´æ¥ç»å†ä¸€äº›çŠ¶æ€è½¬æ¢ï¼Œç„¶åè·³åˆ°å¯¹åº”çš„å¼‚å¸¸å¤„ç†å‡½æ•°ã€‚åˆæ¯”å¦‚ç¯å¢ƒè°ƒç”¨åŒæ­¥å¼‚å¸¸ecallä¸»è¦æ˜¯ç”¨äºä½ æƒé™çš„modeéœ€è¦é«˜æƒé™çš„modeçš„ç›¸å…³æ“ä½œæ—¶ä½¿ç”¨çš„ï¼Œæ¯”å¦‚U-mode call S-mode é€šå¸¸ç”¨äºä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œè€ŒS-mode call M-modeé€šå¸¸ç”¨äºåœ¨S-modeæ“ä½œæŸäº›ç¡¬ä»¶ï¼Œè¿™åœ¨æœ¬å®éªŒä¼šç”¨åˆ°ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸ç®¡æ˜¯ä¸­æ–­è¿˜æ˜¯åŒæ­¥å¼‚å¸¸ï¼Œéƒ½ä¼šç»å†ç›¸ä¼¼çš„ç¡¬ä»¶çŠ¶æ€è½¬æ¢ï¼Œå¹¶è·³åˆ°åŒä¸€ä¸ªå¼‚å¸¸å¤„ç†åœ°å€ï¼ˆç”± mtvec/stvecæŒ‡å®šï¼‰ï¼Œå†ç”±å¤„ç†å‡½æ•°åˆ†æå¼‚å¸¸å‡ºç°åŸå› å¹¶è¿›è¡Œä¸åŒçš„å¤„ç†ã€‚

### Trap in S mode

S æ¨¡å¼ä¸ç›´æ¥æ§åˆ¶æ—¶é’Ÿä¸­æ–­å’Œè½¯ä»¶ä¸­æ–­ï¼Œè€Œæ˜¯ä½¿ç”¨ ecall æŒ‡ä»¤è¯·æ±‚ M æ¨¡å¼è®¾ç½®å®šæ—¶å™¨æˆ–ä»£è¡¨å®ƒå‘é€å¤„ç†å™¨é—´ä¸­æ–­ã€‚è¯¥è½¯ä»¶çº¦å®šæ˜¯ç›‘ç®¡è€…äºŒè¿›åˆ¶æ¥å£(Supervisor Binary Interface)çš„ä¸€éƒ¨åˆ†ã€‚

ç”±äºhartä½äºSupervisor modeï¼Œæˆ‘ä»¬éœ€è¦åœ¨Supervisor modeä¸‹å¤„ç†å¼‚å¸¸ã€‚è¿™æ—¶é¦–å…ˆè¦æåˆ°å§”æ‰˜ï¼ˆdelegationï¼‰æœºåˆ¶ã€‚

#### å§”æ‰˜ï¼ˆdelegationï¼‰

RISC-Væ¶æ„æ‰€æœ‰modeçš„å¼‚å¸¸åœ¨é»˜è®¤æƒ…å†µä¸‹éƒ½è·³è½¬åˆ°Machine modeå¤„ç†ã€‚ä¸ºäº†æé«˜æ€§èƒ½ï¼ŒRISC-Væ”¯æŒå°†ä½æƒé™modeäº§ç”Ÿçš„å¼‚å¸¸å§”æ‰˜ç»™å¯¹åº”modeå¤„ç†ã€‚è¿™é‡Œä½¿ç”¨äº†midelegå’Œmedelegä¸¤ä¸ªå¯„å­˜å™¨ï¼Œå®ƒä»¬çš„åŠŸèƒ½å¦‚ä¸‹ï¼šï¼ˆæ›´å…·ä½“çš„ä»‹ ç»å‚è€ƒThe RISC-V Instruction Set Manual 3.1.8èŠ‚ï¼‰

* midelegï¼ˆMachine Interrupt Delegationï¼‰ï¼šæ§åˆ¶å°†å“ªäº›å¼‚å¸¸å§”æ‰˜ç»™å¯¹åº”modeå¤„ç†ï¼Œå®ƒçš„ç»“æ„å¯ä»¥å‚è€ƒmipå¯„å­˜å™¨ï¼Œæ¯”å¦‚å°†mipä¸­stipå¯¹åº”çš„ä½ç½®ä½ä¼šå°†Supervisor modeçš„æ—¶é’Ÿä¸­æ–­å§”æ‰˜ç»™Supervisor modeå¤„ç† 
* medelegï¼ˆMachine Exception Delegationï¼‰ï¼šæ§åˆ¶å°†å“ªäº›å¼‚å¸¸å§”æ‰˜ç»™å¯¹åº”modeå¤„ç†ï¼Œå®ƒçš„å„ä¸ªä½å¯¹åº”mcauseå¯„å­˜å™¨çš„è¿”å›å€¼

#### Supervisor Modeä¸‹æ—¶é’Ÿä¸­æ–­å¤„ç†æµç¨‹

äº‹å®ä¸Šï¼Œè™½ç„¶åœ¨midelegä¸­è®¾ç½®äº†å°†Supervisor modeäº§ç”Ÿçš„æ—¶é’Ÿä¸­æ–­å§”æ‰˜ç»™Supervisor modeï¼Œå§”æ‰˜å¹¶æ²¡æœ‰å®Œæˆã€‚å› ä¸ºç¡¬ä»¶äº§ç”Ÿçš„æ—¶é’Ÿä¸­æ–­ä»ä¼šå‘åˆ°Machine modeï¼ˆmtimeå¯„å­˜å™¨æ˜¯Machine modeçš„è®¾å¤‡ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨è§¦å‘Supervisor modeä¸‹çš„æ—¶é’Ÿä¸­æ–­ã€‚

æ­¤å‰ï¼Œå‡è®¾è®¾ç½®å¥½[m|s]statusä»¥åŠ[m|s]ieï¼Œå³æˆ‘ä»¬å·²ç»æ»¡è¶³äº†æ—¶é’Ÿä¸­æ–­åœ¨ä¸¤ç§modeä¸‹è§¦å‘çš„ä½¿èƒ½æ¡ä»¶ã€‚æ¥ä¸‹æ¥ ä¸€ä¸ªæ—¶é’Ÿä¸­æ–­çš„å§”æ‰˜æµç¨‹å¦‚ä¸‹ï¼š

1. å½“mtimecmpå°äºmtimeæ—¶ï¼Œè§¦å‘æ—¶é’Ÿä¸­æ–­å¹¶ä¸”ç¡¬ä»¶è‡ªåŠ¨ç½®ä½mip[mtip]
2. æ­¤æ—¶mstatus[mie]=1ï¼Œmie[mtie]=1ï¼Œä¸”mip[mtip]=1 è¡¨ç¤ºå¯ä»¥å¤„ç†machine modeçš„æ—¶é’Ÿä¸­æ–­ã€‚
3. æ­¤æ—¶hartå‘ç”Ÿäº†å¼‚å¸¸ï¼Œç¡¬ä»¶ä¼šè‡ªåŠ¨ç»å†çŠ¶æ€è½¬æ¢ï¼Œå…¶ä¸­pcè¢«è®¾ç½®è¢«mtvecï¼Œå³è·³è½¬åˆ°æˆ‘ä»¬è®¾ç½®å¥½çš„machine modeå¤„ç†å‡½æ•°å…¥å£ã€‚
4. machine modeå¤„ç†å‡½æ•°åˆ†æå¼‚å¸¸åŸå› ï¼Œåˆ¤æ–­ä¸ºæ—¶é’Ÿä¸­æ–­ï¼Œä¸ºäº†å°†æ—¶é’Ÿä¸­æ–­å§”æ‰˜ç»™supervisor modeï¼Œäºæ˜¯==å°†mip[stip]ç½®ä½==ï¼Œå¹¶ä¸”ä¸ºäº†é˜²æ­¢åœ¨supervisor modeå¤„ç†æ—¶é’Ÿä¸­æ–­æ—¶ç»§ç»­è§¦å‘machine modeæ—¶é’Ÿä¸­æ–­ï¼Œäºæ˜¯åŒæ—¶==å°†mie[mtie]æ¸…é›¶==ã€‚
5. machine modeå¤„ç†å‡½æ•°å¤„ç†å®Œæˆå¹¶é€€å‡ºï¼Œæ­¤æ—¶sstatus[sie]=1ï¼Œsie[stie]=1ï¼Œä¸”sip[stip]=1(ç”±äºsipæ˜¯mipçš„å­é›†ï¼Œ æ‰€ä»¥ç¬¬4æ­¥ä¸­ä»¤mip[stip]ç½®ä½ç­‰åŒäºå°†sip[stip]ç½®ä½)ï¼Œäºæ˜¯è§¦å‘supervisor modeçš„æ—¶é’Ÿä¸­æ–­ã€‚
6. æ­¤æ—¶hartå‘ç”Ÿäº†å¼‚å¸¸ï¼Œç¡¬ä»¶è‡ªåŠ¨ç»å†çŠ¶æ€è½¬æ¢ï¼Œå…¶ä¸­pcè¢«è®¾ç½®ä¸ºstvecï¼Œå³è·³è½¬åˆ°æˆ‘ä»¬è®¾ç½®å¥½çš„supervisor mode å¤„ç†å‡½æ•°å…¥å£ã€‚
7. supervisor modeå¤„ç†å‡½æ•°åˆ†æå¼‚å¸¸åŸå› ï¼Œåˆ¤æ–­ä¸ºæ—¶é’Ÿä¸­æ–­ï¼Œäºæ˜¯è¿›è¡Œç›¸åº”çš„æ“ä½œï¼Œå®Œæˆåå°†sip[stip]æ¸…é›¶ï¼Œè¡¨ç¤ºå¤„ç†å®Œæ¯•ï¼Œç„¶ååˆ©ç”¨ecallè§¦å‘å¼‚å¸¸ï¼Œè·³è½¬åˆ°machine modeçš„å¼‚å¸¸å¤„ç†å‡½æ•°è¿›è¡Œæœ€åçš„æ”¶å°¾ã€‚
8. machine modeå¼‚å¸¸å¤„ç†å‡½æ•°åˆ†æå¼‚å¸¸åŸå› ï¼Œå‘ç°ä¸ºecall from S-modeï¼Œäºæ˜¯è®¾ç½®mtimecmp+=100000ï¼Œå¹¶ä¸”è®¾ç½®mie[mtie]æ¢å¤machine modeçš„ä¸­æ–­ä½¿èƒ½ï¼Œä¿è¯ä¸‹ä¸€æ¬¡æ—¶é’Ÿä¸­æ–­å¯ä»¥è§¦å‘ã€‚
9. å‡½æ•°é€çº§è¿”å›ï¼Œæ•´ä¸ªå§”æ‰˜çš„æ—¶é’Ÿä¸­æ–­å¤„ç†å®Œæ¯•ã€‚

**æ³¨æ„**

1. æ—¶é—´ä¸­æ–­å¿…é¡»åœ¨Mæ¨¡å¼ä¸‹è¿›è¡Œï¼Œç„¶åå†é€šè¿‡delegationåˆ†é…ç»™Sæ¨¡å¼è¿›è¡Œå¤„ç†

### Regs specification

#### mstatus/sstaus

mstatus[3]=mie

[m|s]status[1]=sie

#### mtime(cmp)

Machine Time Reg. Use MMIO to access. Function specified in [Trap](# ç¡¬ä»¶ä¸­æ–­çš„å¤„ç†ï¼ˆä»¥æ—¶é’Ÿä¸­æ–­ä¸ºä¾‹ï¼‰)

#### mideleg

Machine Trap Delegation Reg

Delegated interrupts result in the interrupt being masked at the delegator privilege level. For example, if the supervisor timer interrupt (STI) is delegated to S-mode by setting mideleg[5], STIs will not be taken when executing in M-mode. By contrast, if mideleg[5] is clear, STIs can be taken in any mode and regardless of current mode will transfer control to M-mode.

mideleg holds trap delegation bits for individual interrupts, with the layout of bits matching those in the mip register (i.e., STIP interrupt delegation control is located in bit 5).

midelegï¼ˆMachine Interrupt Delegationï¼Œæœºå™¨ä¸­æ–­å§”æ‰˜ï¼‰CSR æ§åˆ¶å°†å“ªäº›ä¸­æ–­å§”æ‰˜ç»™ S æ¨¡å¼ã€‚ä¸ mip å’Œ mie ä¸€æ ·ï¼Œmideleg ä¸­çš„æ¯ä¸ªä½å¯¹åº”äºå›¾ 10.3 ä¸­ç›¸åŒçš„å¼‚å¸¸ã€‚ä¾‹å¦‚ï¼Œ mideleg[5]å¯¹åº”äº S æ¨¡å¼çš„æ—¶é’Ÿä¸­æ–­ï¼Œå¦‚æœæŠŠå®ƒç½®ä½ï¼ŒS æ¨¡å¼çš„æ—¶é’Ÿä¸­æ–­å°†ä¼šç§»äº¤ S æ¨¡å¼çš„å¼‚å¸¸å¤„ç†ç¨‹åºï¼Œè€Œä¸æ˜¯ M æ¨¡å¼çš„å¼‚å¸¸å¤„ç†ç¨‹åºã€‚ å§”æ‰˜ç»™ S æ¨¡å¼çš„ä»»ä½•ä¸­æ–­éƒ½å¯ä»¥è¢« S æ¨¡å¼çš„è½¯ä»¶å±è”½ã€‚sieï¼ˆSupervisor Interrupt Enableï¼Œç›‘ç®¡è€…ä¸­æ–­ä½¿èƒ½ï¼‰å’Œ sipï¼ˆSupervisor Interrupt Pendingï¼Œç›‘ç®¡è€…ä¸­æ–­å¾…å¤„ç†ï¼‰CSR æ˜¯ S æ¨¡å¼çš„æ§åˆ¶çŠ¶æ€å¯„å­˜å™¨ï¼Œä»–ä»¬æ˜¯ mie å’Œ mip çš„å­é›†ã€‚å®ƒä»¬æœ‰ç€å’Œ M æ¨¡å¼ä¸‹ç›¸åŒçš„å¸ƒå±€ï¼Œä½†<u>åœ¨ sie å’Œ sip ä¸­åªæœ‰ä¸ç”± mideleg å§”æ‰˜çš„ä¸­æ–­å¯¹åº”çš„ä½æ‰èƒ½è¯»å†™</u>ã€‚é‚£äº›æ²¡æœ‰è¢«å§”æ´¾çš„ä¸­æ–­å¯¹åº”çš„ä½å§‹ç»ˆä¸ºé›¶ã€‚

#### mcause/scause

| reg    | Type         | Mode+Code |
| ------ | ------------ | --------- |
| mcause | M timer      | 1+7       |
| mcause | ecall from S | 0+9       |
| scause | S timer      | 1+5       |

#### sie/sip

<img src="assets/image-20201018132153939.png" style="zoom:50%;" />

#### mie/mip

mipå¯„å­˜å™¨ç”¨äºæŸ¥è¯¢ä¸­æ–­çš„ç­‰å¾…çŠ¶æ€ï¼Œè½¯ä»¶å¯ä»¥é€šè¿‡è¯»mipå¯„å­˜å™¨è¾¾åˆ°æŸ¥è¯¢ä¸­æ–­çŠ¶æ€çš„ç»“æœã€‚

<img src="assets/image-20201028100115880.png" alt="image-20201028100115880" style="zoom:50%;" />

### New Instructions

* ld rd, offset(rs1)
    * x[rd] = M\[x\[rs1\] + sext(offset)\]\[63:0\]
    * åŒå­—åŠ è½½ (Load Doubleword). I-type, RV32I and RV64I.
    * ä»åœ°å€ x[rs1] + sign-extend(offset)è¯»å–å…«ä¸ªå­—èŠ‚ï¼Œå†™å…¥ x[rd]ã€‚
    * å‹ç¼©å½¢å¼ï¼šc.ldsp rd, offset; c.ld rd, offset(rs1)
* sd rs2, offset(rs1)
    * M[x[rs1] + sext(offset) = x\[rs2][63:0]
    * å­˜åŒå­—(Store Doubleword). S-type, RV64I only.
    * å°† x[rs2]ä¸­çš„ 8 å­—èŠ‚å­˜å…¥å†…å­˜åœ°å€ x[rs1]+sign-extend(offset)ã€‚
    * å‹ç¼©å½¢å¼ï¼šc.sdsp rs2, offset; c.sd rs2, offset(rs1)
* auipc rd, immediate
    * x[rd] = pc + sext(immediate[31:12] << 12)
    * PC åŠ ç«‹å³æ•° (Add Upper Immediate to PC). U-type, RV32I and RV64I.
    * æŠŠç¬¦å·ä½æ‰©å±•çš„ 20 ä½ï¼ˆå·¦ç§» 12 ä½ï¼‰ç«‹å³æ•°åŠ åˆ° pc ä¸Šï¼Œç»“æœå†™å…¥ x[rd]ã€‚
* sret
    * ExceptionReturn(Supervisor)
    * ç®¡ç†å‘˜æ¨¡å¼ä¾‹å¤–è¿”å›(Supervisor-mode Exception Return). R-type, RV32I and RV64I ç‰¹æƒæŒ‡ä»¤ã€‚
    * ä»ç®¡ç†å‘˜æ¨¡å¼çš„ä¾‹å¤–å¤„ç†ç¨‹åºä¸­è¿”å›ï¼Œè®¾ç½® pc ä¸º CSRs[spec]ï¼Œæƒé™æ¨¡å¼ä¸º CSRs[sstatus].SPPï¼ŒCSRs[sstatus].SIE ä¸º CSRs[sstatus].SPIEï¼ŒCSRs[sstatus].SPIE ä¸º 1ï¼ŒCSRs[sstatus].spp ä¸º 0ã€‚
    * The SRET instruction is used to return from a trap taken into HS-mode or VS-mode. Its behavior depends on the current virtualization mode.
* mret
    * ExceptionReturn(Machine)
    * æœºå™¨æ¨¡å¼å¼‚å¸¸è¿”å›(Machine-mode Exception Return). R-type, RV32I and RV64I ç‰¹æƒæ¶æ„
    * ä»æœºå™¨æ¨¡å¼å¼‚å¸¸å¤„ç†ç¨‹åºè¿”å›ã€‚å°† pc è®¾ç½®ä¸º CSRs[mepc], å°†ç‰¹æƒçº§è®¾ç½®æˆ CSRs[mstatus].MPP, CSRs[mstatus].MIE ç½®æˆ CSRs[mstatus].MPIE, å¹¶ä¸”å°† CSRs[mstatus].MPIE ä¸º 1;å¹¶ä¸”ï¼Œå¦‚æœæ”¯æŒç”¨æˆ·æ¨¡å¼ï¼Œåˆ™å°† CSR [mstatus].MPP è®¾ç½®ä¸º 0ã€‚
    * The MRET instruction is used to return from a trap taken into M-mode. MRET first determines what the new operating mode will be according to the values of MPP and MPV in mstatus or mstatush, as encoded in Table 5.6. MRET then in mstatus/mstatush sets MPV=0, MPP=0, MIE=MPIE, and MPIE=1. Lastly, MRET sets the virtualization and privilege modes as previously determined, and sets pc=mepc.
    * mret å°† PC è®¾ç½®ä¸º mepcï¼Œé€šè¿‡å°† mstatus çš„ MPIE åŸŸå¤åˆ¶åˆ° MIE æ¥æ¢å¤ä¹‹å‰çš„ä¸­æ–­ä½¿èƒ½è®¾ç½®ï¼Œå¹¶å°†æƒé™æ¨¡å¼è®¾ç½®ä¸º mstatus çš„ MPP åŸŸä¸­çš„å€¼ã€‚ è¿™åŸºæœ¬æ˜¯å‰ä¸€æ®µä¸­æè¿°çš„é€†æ“ä½œã€‚
* ecall
    * RaiseException(EnvironmentCall)
    * ç¯å¢ƒè°ƒç”¨ (Environment Call). I-type, RV32I and RV64I.
    * é€šè¿‡å¼•å‘ç¯å¢ƒè°ƒç”¨å¼‚å¸¸æ¥è¯·æ±‚æ‰§è¡Œç¯å¢ƒã€‚
* csrr rd, csr
    * x[rd] = CSRs[csr]
    * è¯»æ§åˆ¶çŠ¶æ€å¯„å­˜å™¨ (Control and Status Register Read). ä¼ªæŒ‡ä»¤(Pesudoinstruction), RV32I and RV64I.
    * æŠŠæ§åˆ¶çŠ¶æ€å¯„å­˜å™¨ csr çš„å€¼å†™å…¥ x[rd]ï¼Œç­‰åŒäº csrrs rd, csr, x0.



# Lab Steps

## Lab Env

```zsh
$ docker run --name lab2 -it -v /mnt/c/Users/Ulysses/OneDrive/Jun_A/OS/Lab/Lab2/source:/home/oslab/lab2 -u oslab -w /home/oslab/lab2 oslab:2020 /bin/bash # ä½¿ç”¨--nameå‘½å
$ docker start lab2
$ docker exec -it -u oslab -w /home/oslab/lab2 lab2 bash
oslab@094e57b84b1c:~$ ls
lab0  lab2
oslab@094e57b84b1c:~$ cd lab2
oslab@094e57b84b1c:~/lab2$ ls
Makefile  arch  include  init  lib
```

## Bootloader

ç…§ç€ä¸Šæ¬¡çš„ä¿®æ”¹ï¼Œé—®é¢˜ä¸å¤§ï¼Œéœ€è¦æ³¨æ„çš„ç‚¹éƒ½åœ¨[debugå¿ƒå¾—](# Problems(Debug))ä¸­å†™äº†ï¼Œéœ€è¦å¦å¤–æ³¨æ„çš„ç‚¹æœ‰ï¼š

* bssæ®µéœ€è¦åˆå§‹åŒ–ï¼Œå¯ä»¥é€šè¿‡å¾ªç¯å­˜0å®ç°
* mstatus.mpieéœ€è¦ç½®ä½ï¼Œå¦åˆ™mretä¹‹åmstatus.mieä¼šè¢«å¤ä½ï¼Œè¿™ç‚¹æ–‡æ¡£é‡Œæ²¡æœ‰è¯´ï¼Œè¦æ ¼å¤–å°å¿ƒ
* é‚£å‡ ä¸ªä½¿èƒ½ç½®ä½çš„æ³¨æ„ç¬¬å‡ ä½åˆ«å¼„é”™äº†å°±è¡Œ

## strap

è°ƒç”¨putåº“é‡Œçš„putså’Œputiæ¥å£å³å¯

```c
void put_trap_s(void) {
    static int counter = 0;
    puts("[S] Supervisor Mode Timer Interrupt ");
    puti(counter++);
    puts("\n");
    return;
}
```

## Trap_m

### åŸºæœ¬æ¡†æ¶

å…ˆæŠŠå¯„å­˜å™¨å‹æ ˆï¼Œè¿™é‡Œå‹äº†t0, t1, mcause, mepcå››ä¸ªï¼Œæ³¨æ„è¦å…ˆå‹é€šç”¨å¯„å­˜å™¨ï¼Œå†ç”¨é€šç”¨å¯„å­˜å™¨ä½œä¸ºCSRçš„ä¸­è½¬ï¼Œå‡ºæ ˆç›¸å

é¦–å…ˆåˆ¤æ–­æ˜¯ä¸­æ–­è¿˜æ˜¯åŒæ­¥å¼‚å¸¸ï¼š

```assembly
csrr t0, mcause
srli t1, t0, 63    # t1 = MSB
andi t0, t0, 0xff  # t0 = code
beq t1, zero, trap_m_except

trap_m_int:
    ...

trap_m_except:
    ...
```

å¯¹äºä¸­æ–­å’Œå¼‚å¸¸ï¼Œåˆ†åˆ«è¦åˆ¤æ–­å…¶é”™è¯¯codeæ˜¯å¦å’Œè¦æ±‚çš„ä¸€æ ·ï¼Œæ­¤å¤„ä»¥åŒæ­¥å¼‚å¸¸ç±»å‹çš„åˆ¤æ–­ä¸ºä¾‹ï¼ˆæ³¨æ„åŒæ­¥å¼‚å¸¸çš„mepcè¦+4ï¼‰ï¼š

```assembly
trap_m_except:
    la t1, mcause_ecallS
    beq t0, t1, trap_m_ecallS
    la ...
    beq ...
    j trap_m_except_end

    trap_m_ecallS:
        ...

    trap_m_otherExcept:
        ...

    trap_m_except_end:
            ld t0, 24(sp)
            addi t0, t0, 4  # mepc += 4
            sd t0, 24(sp)
```

### æ—¶é’Ÿä¸­æ–­

ä»»åŠ¡å¦‚ä¸‹ï¼š

1. ç½®ä½mip.stipï¼Œç”±äºsipåœ¨Mæ¨¡å¼åªè¯»ï¼Œæ‰€ä»¥è¦é€šè¿‡ä¿®æ”¹mipçš„æ–¹å¼æ¥ä¿®æ”¹ï¼Œç›®çš„æ˜¯è®©trap_sèƒ½è¢«è°ƒç”¨ï¼Œä¸”ä¿è¯scause=0x5ï¼ˆSæ¨¡å¼æ—¶é’Ÿä¸­æ–­ï¼‰
2. å¤ä½mie.mtieï¼Œå…³é—­è¿™ä¸ªä¹‹åï¼Œå°±ä¸ä¼šå†æœ‰Mæ¨¡å¼çš„æ—¶é’Ÿä¸­æ–­äº†ï¼Œè¿™æ ·å¯ä»¥é¿å…å¦å¤–ä¸¤ä¸ªå‡½æ•°åœ¨å¤„ç†æ—¶è¢«è¿™ä¸ªä¸­æ–­å¹²æ‰°ï¼ˆä½†æ˜¯ç”±äºæˆ‘æœ‰ç”¨æ ˆä¿æŠ¤å…³é”®å¯„å­˜å™¨æ‰€ä»¥é—®é¢˜ä¸å¤§ï¼Œé™¤éå‹æ ˆåˆ°ä¸€åŠçš„æ—¶å€™è¢«è°ƒç”¨ï¼‰

### æ¥è‡ªSçš„ecall

1. å¤ä½mip.stipï¼Œæ­¤æ­¥æ˜¯ä¸ºäº†é¿å…trap_sè¢«é‡å¤è°ƒç”¨ï¼Œæ–‡æ¡£ä¸Šè¡¨è¾¾æ„Ÿè§‰ä¸å¤ªå¯¹ï¼Œè¦å¤šåŠ å°å¿ƒ
2. ç»™mtimecmpåŠ ä¸Štime_sepï¼Œä½†æ˜¯ç”±äºtime_sepå¯èƒ½ä¼šå¤ªå°ï¼ˆæ¯”è¿è¡Œè¿™ä¸ªå¾ªç¯æ‰€éœ€æ—¶é—´è¿˜å°ï¼‰å¯¼è‡´ç¨‹åºä¸æ–­å‡ºå‘ä¸­æ–­ï¼Œå› æ­¤æˆ‘æ”¹ä¸ºä»¤mtimecmp = mtime + time_sepï¼ˆè™½ç„¶ä¹Ÿä¸èƒ½å®Œå…¨è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè€Œä¸”è¿™ä¸¤ä¸ªloadä¹‹é—´å…¶å®æ²¡å·®å‡ ä¸ªå‘¨æœŸ
3. é‡æ–°ç½®ä½mie.mtieï¼Œä»¥ä¾¿äºä¸‹ä¸€æ¬¡æ—¶é’Ÿä¸­æ–­èƒ½æ­£å¸¸è°ƒç”¨trap_m

## Trap_s

å‹æ ˆå’Œæ¡†æ¶å’Œtrap_måŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œå®é™…ä¸Šè¦å¹²çš„äº‹æƒ…åªæœ‰ä¸¤è¡Œ

```assembly
call put_trap_s
ecall
```

è‡³äºsip.stipçš„å¤ä½ï¼Œæˆ‘åœ¨trap_m_ecallSé‡Œå®ç°äº†ï¼Œå› ä¸ºtrap_sçš„Sæ¨¡å¼ä¸‹æ²¡åŠæ³•ä¿®æ”¹sip.stip

## Debug

debugè¿‡ç¨‹ç”±äºæ‡’å¾—æ¯æ¬¡éƒ½æ‰“ä¸€å †æŒ‡ä»¤ï¼Œäºæ˜¯åœ¨sourceæ–‡ä»¶å¤¹ä¸‹å†™äº†ä¸€ä¸ª.gdbinitï¼Œç„¶åç”¨è½¯é“¾æ¥`ln ~/lab2/.gdbinit ~/.gdbinit`ï¼Œå†åœ¨.bashrcé‡ŒåŠ ä¸€å¥`alias gdb=/opt/riscv/bin/riscv64-unknown-linux-gnu-gdb`å³å¯ç›´æ¥é€šè¿‡`gdb vmlinux`è¿™ä¸ªæŒ‡ä»¤æ¥å¯åŠ¨gdbäº†ã€‚

debugå¿ƒå¾—è§[æ­¤å¤„](# Problems(Debug))ã€‚

ä»¥ä¸‹è®°å½•ä¸€äº›ç”¨åˆ°çš„æŒ‡ä»¤ï¼š

```
gdb vmlinux -x .gdbinit

layout reg
layout asm
b _start
b start_kernel
b *0x800001c8
ni 10  # for asm
si 20  # for asm
x /d 0x200bff8
x /d 0x2004000
display (long)*0x200bff8
display (long)*0x2004000
x /b $mstatus
x $medeleg
i reg mtvec
n 10
s 10
p /d *0x2004000-*0x200bff8

# .gdbinit
set breakpoint pending on
set output-radix 10
target remote localhost:1234
layout reg
b _start
b trap_s
b trap_m_timer
b trap_m_ecallS
display (long)*0x200bff8
display (long)*0x2004000
```



# Lab Results

![](assets/image-20201029185054233.png)

ç”±æˆªå›¾å¯è§å¯ä»¥æ­£ç¡®ç¼–è¯‘ã€è¿è¡Œã€æ¸…é™¤æ–‡ä»¶ï¼ˆå·¦ä¾§åˆ†å±ç¼–è¯‘è¿è¡Œï¼Œå³ä¾§åˆ†å±killå¹¶make cleanï¼‰ï¼Œå®éªŒæˆåŠŸï¼Œå…¶ä¸­æ‰“å°çš„å¿«æ…¢å¯ä»¥é€šè¿‡ä¿®æ”¹ldsæ–‡ä»¶ä¸­çš„`time_sep`ç¬¦å·çš„å€¼æ¥ä¿®æ”¹ï¼Œå…·ä½“çš„åŠ¨æ€æ•ˆæœå¯ä»¥è§è§†é¢‘ã€‚

å¯ä»¥æ­£å¸¸debugï¼Œç¤ºæ„å¦‚ä¸‹ï¼š

![](assets/image-20201029185422528.png)

![](assets/image-20201029194625281.png)

ä»è°ƒè¯•ç»“æœå¯ä»¥çœ‹å‡ºï¼Œtrap_m_timer, trap_s, trap_m_ecallSä¼šè¢«ä¾æ¬¡å¾ªç¯è°ƒç”¨ï¼Œç¬¦åˆè¦æ±‚ã€‚



# Problems & Thoughts

## æ€è€ƒé¢˜

* æ€è€ƒé¢˜ï¼šè§‚å¯Ÿvmlinuxå’Œimageï¼Œè§£é‡Šä¸ºä»€ä¹ˆè¦åˆå§‹åŒ–bssæ®µã€‚
    * bssæ®µå­˜å‚¨æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡
    * è§‚å¯Ÿvmlinuxä¸­çš„`la t0, .bss`æ®µï¼Œå‘ç°å…¶åæ±‡ç¼–åçš„æŒ‡ä»¤ä¸º`auipc t0,0x0; addi t0,t0,1130`ï¼Œæ‰€ä»¥ç”¨`display (int[100])*1130`æŸ¥çœ‹è¿™ä¸€æ®µï¼Œå‘ç°æ•°æ®æœ¬æ¥å°±æ˜¯0ï¼š`(int[100])*1130 = {0x0 <repeats 100 times>}`ï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºASLRæ²¡å¼€ï¼ˆå…¶å®è¿™ä¸ªé—®é¢˜ä¸å¤§ï¼Œåªæ˜¯æˆ‘è§‚å¯Ÿåˆ°çš„å°é—®é¢˜ï¼‰
    * ä¸»è¦çš„åŸå› æ˜¯åƒ`static int a = 0;`ï¼ˆå³ä½¿åˆå§‹åŒ–ä½†å€¼ä¸º0ï¼‰è¿™æ ·çš„æ•°æ®ä¹Ÿä¼šè¢«æ”¾åˆ°bssæ®µè€Œä¸æ˜¯dataæ®µï¼Œæ‰€ä»¥å¿…é¡»è¦å¯¹bssæ®µåŠé€†è¡Œåˆå§‹åŒ–æ‰èƒ½é¿å…ä½¿ç”¨äº†é”™è¯¯çš„å˜é‡å€¼ã€‚
* æ€è€ƒé¢˜ï¼šå½“å¤„ç†åŒæ­¥å¼‚å¸¸æ—¶åº”è¯¥åœ¨é€€å‡ºå‰ç»™mepc+4ï¼Œå½“å¤„ç†ä¸­æ–­æ—¶åˆ™ä¸éœ€è¦ï¼Œè¯·è§£é‡Šä¸ºä»€ä¹ˆè¦è¿™æ ·åšã€‚
    * åŒæ­¥å¼‚å¸¸çš„è¯å¦‚æœæ²¡+4ï¼Œè¿”å›ä¹‹åå°±ä¼šç»§ç»­æ‰§è¡Œè¿™å¥å¼•èµ·åŒæ­¥å¼‚å¸¸çš„æŒ‡ä»¤(ä¾‹å¦‚ecall)ï¼Œç„¶åç»§ç»­åŒæ­¥å¼‚å¸¸çš„æ­»å¾ªç¯ï¼Œæ‰€ä»¥éœ€è¦+4æ¥è·³è¿‡è¿™å¥
    * è€Œä¸­æ–­çš„æƒ…å†µmepcå¯¹åº”çš„æŒ‡ä»¤æœ¬èº«æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå› æ­¤è¢«ä¸­æ–­ä¹‹åè¦é‡æ–°æ‰§è¡Œè¿™ä¸ªè¯­å¥ï¼Œæ‰€ä»¥ä¸èƒ½+4

## Problems(Debug)

è®°å½•debugé‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ€è·¯

1. mtvecå’Œstvecè®¾ç½®é”™è¯¯ï¼Œæœ¬æ¥çš„åœ°å€åˆ†åˆ«æ˜¯0xc4å’Œ0x118ï¼Œç»“æœç”±äºç”¨äº†vectorizedæ¨¡å¼ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥å°†pcè·³è½¬åˆ°BASE

2. è¿˜æ˜¯mtvecå’Œstvecçš„é—®é¢˜ï¼Œ==è¿™ä¸¤ä¸ªçš„BASEå…¶å®æ˜¯å­—åœ°å€==ï¼Œæ‰€ä»¥ä¸éœ€è¦å·¦ç§»ä¸¤ä½ï¼ˆè¿™ä¹Ÿå¤ªå‘äº†æ‰‹å†Œä¸Šåªè¯´äº†"4-byte aligned"ï¼Œæ²¡è¯´è¿™æ˜¯å­—åœ°å€å•Šã€‚ã€‚ã€‚ğŸ¤§ï¼‰

3. ç„¶åå¯ä»¥æ­£å¸¸è¾“å‡ºäº†ï¼Œä½†æ˜¯è¾“å‡ºä¸€æ¬¡å°±åˆå¡æ­»äº†ï¼Œè¿™æ˜¾ç„¶æ˜¯è®¾ç½®mtimecmpå‡ºç°é”™è¯¯é€ æˆçš„ï¼Œæˆ‘å‘ç°è¿™ä¹Ÿtrap_sæ²¡æ³•è¿›å…¥trap_mé‡è®¾è¿™ä¸ªè®¡æ—¶å™¨å¯„å­˜å™¨ï¼Œäºæ˜¯å¼ºåˆ¶åŠ äº†ä¸€ä¸ªè·³è½¬ï¼Œç„¶åå¯ä»¥å¾ªç¯è¾“å‡ºäº†ï¼Œä½†æ˜¯æœ‰ä»¥ä¸‹é—®é¢˜ï¼š

    * ä¼šæŠŠheaderä¹Ÿè·Ÿç€ä¸€èµ·è¾“å‡º

        * ```
            [S] Supervisor Mode Timer Interrupt 31ZJU OS LAB 2             GROUP-17
            [S] Supervisor Mode Timer Interrupt 32ZJU OS LAB 2             GROUP-17
            [S] Supervisor Mode Timer Interrupt 33ZJU OS LAB 2             GROUP-17
            ```
        
    * é€Ÿåº¦éå¸¸å¿«ï¼ˆé€šè¿‡æ‰‹æœºç§’è¡¨æµ‹é‡å‘ç°ä¸º0.01ç§’ä¸€ä¸ªï¼‰
    * æ— æ³•é€šè¿‡^cç»ˆæ­¢
    
4. åˆ†åˆ«è§£å†³

    * å¤ªå¿«çš„é—®é¢˜æŠŠ1e+5çš„time_sepæ”¹æˆ1e+7å°±æ­£å¸¸ä¸€äº›äº†ï¼ˆä¸€ç§’ä¸€ä¸ªï¼‰
    * å¦å¤–ä¸¤ä¸ªé—®é¢˜ç»è¿‡debugå‘ç°æ˜¯å› ä¸ºtrap_så‡½æ•°å¿˜è®°è¿”å›äº†ï¼Œç”±äºç¼–è¯‘å®Œå’Œstart_kernelæ˜¯è¿åœ¨ä¸€èµ·çš„ï¼Œæ‰€ä»¥ä»puts_trap_så‡½æ•°è¿”å›ä¹‹åç›´æ¥è¿›å…¥äº†start_kernelå‡½æ•°æ‰§è¡Œ
    
5. åæ¥æ¢äº†ä¸ªç»“æ„ä¹‹åå‡ºç°äº†æ–°çš„é—®é¢˜ï¼Œæ—¶é’Ÿä¸­æ–­æ²¡äº†ï¼Œç»è¿‡æ’æŸ¥å‘ç°ç³»ç»Ÿåªä¼šè°ƒç”¨Mæ¨¡å¼çš„ä¸­æ–­ï¼Œä¸ä¼šè°ƒç”¨Sæ¨¡å¼çš„ä¸­æ–­ï¼Œè¿›ä¸€æ­¥å‘ç°mretçš„è¿”å›åœ°å€å¹¶ä¸æ˜¯mepcçš„å€¼è€Œæ˜¯trap_må‡½æ•°å¼€å¤´çš„ä½ç½®ï¼ŒæŸ¥é˜…èµ„æ–™å¾—çŸ¥mretè¦æ»¡è¶³æ¡ä»¶æ‰èƒ½è·³è½¬ã€‚ä¸”<u>é‡æ–°debugå‘ç°åœ¨bootloaderçš„S_Modeå‰é¢é‚£ä¸ªmretä¹‹åMPPå°±æˆäº†00(U mode)</u>

6. åæ¥å‘ç°æ˜¯ç”±äºå°†Mæ¨¡å¼çš„è®¡æ—¶å™¨ä¸­æ–­å’Œecall from Såˆ†ç¦»ä¹‹åå¯¼è‡´æ¯æ¬¡æœºå™¨æ¨¡å¼è®¡æ—¶å™¨ä¸­æ–­æ²¡æœ‰æ›´æ–°mtimecmpï¼Œé‡æ–°callä¸€æ¬¡æ›´æ–°çš„å³å¯å®ç°æœºå™¨æ¨¡å¼ä¸‹çš„æ­£å¸¸è¾“å‡ºã€‚

7. æ¥ç€çš„é—®é¢˜æ˜¯åªèƒ½è¿›å…¥Mæ¨¡å¼çš„ä¸­æ–­ä¸èƒ½è¿›å…¥Sæ¨¡å¼çš„ï¼ŒæŒ‰ç…§[åŸç†éƒ¨åˆ†](# Supervisor Modeä¸‹æ—¶é’Ÿä¸­æ–­å¤„ç†æµç¨‹)æ£€æŸ¥äº†ä¸€éä¹‹åå‘ç°æ˜¯`mip.stip`ä¹Ÿéœ€è¦ç½®ä½ï¼Œä½†é—®é¢˜æ˜¯æˆ‘åŠ å…¥äº†å°†å®ƒç½®ä½çš„ä»£ç ä¹‹åï¼Œæ‰“å°çš„é€Ÿåº¦å¿½ç„¶å˜å¾—éå¸¸ä¹‹å¿«ã€‚ç»è¿‡debugå‘ç°ï¼Œ`trap_s`åªä¼šåœæ­¢ä¸€æ¬¡ï¼Œåªåå°±ä¸ä¼šå†åœï¼Œè¿™æ˜¯å› ä¸ºä¸­é—´çš„`ecall_from_S`å‡½æ•°ä¸­è®¡æ—¶å¯„å­˜å™¨è®¾ç½®å‡ºç°äº†é”™è¯¯

8. ç›´åˆ°è¿™é‡Œæˆ‘æ‰çŸ¥é“é¢˜ç›®çš„æ„æ€æ˜¯trap_mæ˜¯ä¸ªå•ç‹¬çš„å‡½æ•°ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªåˆ†æ”¯åˆ†åˆ«å¤„ç†è®¡æ—¶å™¨ä¸­æ–­å’Œæ¥è‡ªSçš„ecallï¼Œä½†æ˜¯ä¿®æ”¹ä¹‹åä¸çŸ¥é“å“ªé‡Œé”™äº†ï¼Œtrap_sä¸ä¼šå†è¢«ä¸­æ–­è°ƒç”¨äº†ã€‚åæ¥å‘ç°æ˜¯ç”±äºå¯„å­˜å™¨ä½¿ç”¨t0å’Œt1å¼„æ··äº†å¯¼è‡´CSRæ²¡æœ‰è¢«æ­£ç¡®ç½®ä½ã€‚

9. ==MTIP is read-only in mip==

10. å…ˆåå°è¯•äº†ç”¨mip.mtipã€mtimeå’Œmtimecmpæ¥åˆ¤æ–­Mçš„ä¸­æ–­ç±»å‹ï¼Œ==Mçš„ä¸­æ–­ç±»å‹ç”¨mcauseæ¥åˆ¤æ–­==

11. ==If supervisor mode is not implemented, bits SEIP, STIP, and SSIP of mip and SEIE, STIE, and SSIE of mie are hardwired to zeros.==

12. mideleg, mstatus.mpp, sieå‡ä¸èƒ½è¢«ä¿®æ”¹

13. è°ƒç”¨äº†trap_mï¼Œä½†æ˜¯mcauseä¸º"Timer Int from S"ï¼Œè¯´æ˜å§”æ‰˜å¤±è´¥äº†ï¼ˆä½†æ˜¯Sæ—¶é’Ÿä¸­æ–­æˆåŠŸï¼‰

14. ==åŒæ­¥ä¸­æ–­è¿”å›ä¹‹å‰è¦+4ï¼Œä¸ç„¶ä¼šä¸€ç›´ecall==

15. trap_mæ—¶çš„mcauseä¸€ç›´æ˜¯0x9ï¼Œæ‰€ä»¥ä¼šä¸€ç›´è°ƒç”¨ecallSä¸€ç›´æ‰“å°ï¼ˆå¹¶ä¸”é™¤äº†ç¬¬ä¸€æ¬¡ä¹‹å‰çš„æ‰“å°ï¼Œå…¶ä»–çš„é—´éš”æ— æ³•é€šè¿‡time_sepæ§åˆ¶ï¼‰

16. ==åœ¨mretåˆ°S_Modeåmstatus.mieä¼šè¢«ç½®0==ï¼Œè¿™æ˜¯å› ä¸ºmretæ—¶`mstatus.mie<--mstatus.mpie`ï¼Œå³å®éªŒä¸€ä¸­é‚£ä¸ªå› ä¸ºæ–‡æ¡£å†™é”™äº†ä¸€ç›´æ‰¾ä¸åˆ°çš„mipeã€‚

17. Sæ¨¡å¼ä¸‹sipæ²¡æœ‰è¢«æ­£å¸¸ç½®ä½ï¼Œå› æ­¤trap_Såˆšè¿”å›å°±è¢«è°ƒç”¨ï¼Œä¸€ç›´ç»™mtimecmpè‡ªå¢ï¼Œmtimecmpæ²¡æœ‰æ¯”mtimeå°çš„æœºä¼šï¼Œå› æ­¤mtipæ²¡æœ‰è¢«ç½®ä½çš„æœºä¼šã€‚

     * å’Œmtipä¸€æ ·ï¼Œstipæ˜¯åªè¯»çš„ï¼š==If implemented, STIP is read-only in sip, and is set and cleared by the execution environment.==
     * å‹˜è¯¯ï¼šå®éªŒæ‰‹å†Œä¸Šâ€œ7. supervisor modeå¤„ç†å‡½æ•°åˆ†æå¼‚å¸¸åŸå› ï¼Œåˆ¤æ–­ä¸ºæ—¶é’Ÿä¸­æ–­ï¼Œäºæ˜¯è¿›è¡Œç›¸åº”çš„æ“ä½œï¼Œå®Œæˆåå°†sip[stip]æ¸…é›¶ï¼Œè¡¨ç¤ºå¤„ç†å®Œæ¯•ï¼Œç„¶ååˆ©ç”¨ecallè§¦å‘å¼‚å¸¸ï¼Œè·³è½¬åˆ°machine modeçš„å¼‚å¸¸å¤„ç†å‡½æ•°è¿›è¡Œæœ€åçš„æ”¶å°¾ã€‚â€è¿™ä¸ªè¯´æ³•å­˜åœ¨ä¸€å®šçš„è¯¯å¯¼æ€§ã€‚é¦–å…ˆsip.stipåœ¨Sæ¨¡å¼ä¸‹æ˜¯åªè¯»çš„ï¼Œå…¶æ¬¡å³ä½¿è¿›å…¥äº†Mæ¨¡å¼ï¼Œä¹Ÿä¸èƒ½ç›´æ¥ä¿®æ”¹sip.stipï¼Œæ­£ç¡®æ–¹å¼æ˜¯é€šè¿‡ecallè¿›å…¥Mæ¨¡å¼ï¼Œç„¶åç½®ä½mip.stipã€‚æ ¹æœ¬ä¸æ˜¯ä»€ä¹ˆâ€œå…ˆæ¸…é›¶å†åˆ©ç”¨ecallâ€ã€‚

## Thoughts

CSRçš„è®¾ç½®çš„æ—¶å€™ç¬¬å‡ ä½è¦ç½®ä½ã€ä½¿ç”¨csrcè¿˜æ˜¯csrsåƒä¸‡å°å¿ƒï¼Œå†™é”™äº†å¥½å‡ ä¸ªåœ°æ–¹ã€‚å…¶ä»–ç§ç§é—®é¢˜debugå¾—åæ­£å¾ˆå¿ƒç´¯ï¼ŒåŸºæœ¬ä¸Šéƒ½è®°å½•åœ¨ä¸Šé¢äº†ã€‚æœ€åæ€»ç®—æ˜¯æå‡ºæ¥äº†ï¼Œä½†æ˜¯èŠ±äº†å¤ªå¤šæ—¶é—´åœ¨åšè¿™ä¸ªï¼Œæ„Ÿè§‰å¾ˆå—æ‰“å‡»ã€‚

æœ¬æ¬¡å®éªŒå­¦ä¹ äº†RISC-Vä¸‹ä¸­æ–­å’ŒåŒæ­¥å¼‚å¸¸çš„åº•å±‚è°ƒç”¨å’Œåˆ¤æ–­çš„æ–¹æ³•ï¼Œå¹¶ä¸”å¯¹å¯„å­˜å™¨å’ŒæŒ‡ä»¤çš„äº†è§£æ›´åŠ æ·±å…¥ï¼Œå¯¹RISC-Vçš„ä½“ç³»æ¶æ„ä¹Ÿæœ‰äº†æ›´æ·±å…¥çš„ç†è§£ï¼Œç›¸ä¿¡æœ¬æ¬¡å®éªŒå¯¹æˆ‘ä»¥åçš„åœ¨ç¡¬ä»¶æ–¹é¢çš„å­¦ä¹ æœ‰å¾ˆå¤§å¸®åŠ©ã€‚

## Suggestions

è™½ç„¶è€å¸ˆè§‰å¾—è¿™äº›å®éªŒæ²¡ä»€ä¹ˆéš¾åº¦ï¼ˆç¡®å®ï¼‰ï¼Œä½†æ˜¯æ¯æ¬¡å®éªŒéƒ½æœ‰å¾ˆå¤šï¼ˆéå¸¸å¤šï¼‰å‘è¦è¸©ï¼Œå»ºè®®ä»¥åå¯ä»¥åœ¨å®éªŒæŒ‡å—é‡Œåˆ—å‡ºä¸€äº›å¿…è¸©ä¸­çš„å‘ï¼ˆæ¯”å¦‚CSRè¿™ç§åº•å±‚å¯„å­˜å™¨çš„ä½¿ç”¨é™åˆ¶å¤ªå¤šäº†ï¼Œæœ‰æ—¶å€™ä½ ä»¥ä¸ºä½ å†™è¿›å»äº†å…¶å®å®ƒæ˜¯åªè¯»çš„ï¼Œå»ºè®®è¿™æ–¹é¢èƒ½å¤šä¸€ç‚¹tipsï¼‰ï¼Œå¦åˆ™éœ€è¦èŠ±è¶…é¢çš„å­¦ä¹ æ—¶é—´åœ¨OSçš„å®éªŒä¸Šã€‚å³ä½¿æ²¡æœ‰å¤šä¸€ç‚¹tipsä¹Ÿå¸Œæœ›èƒ½ä¸è¦æœ‰é”™ï¼ˆæ¯”å¦‚sip.stipæ˜¯åªè¯»è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºæˆ‘æ˜¯æŒ‰ç…§æ‰‹å†Œæ¥çš„ï¼Œæ‰€ä»¥å®Œå…¨æ²¡æƒ³åˆ°ä¼šé”™ï¼ŒèŠ±äº†å¥½é•¿æ—¶é—´åœ¨æ‰¾è¿™ä¸ªbugï¼‰



# Appendix

## Reference

[M mode Timer Interrupt](http://zju.phvntom.tech/markdown/md2html.php?id=md/RISC-V-Timer.md)

[Beginner trying to set up timer IRQ in assembler: how to print CSRs in GDB? - HiFive1 Rev B - SiFive Forums](https://forums.sifive.com/t/beginner-trying-to-set-up-timer-irq-in-assembler-how-to-print-csrs-in-gdb/2764/2)

[RISC-Vå¼‚å¸¸ä¸ä¸­æ–­æœºåˆ¶æ¦‚è¿° | SunnyChençš„å°çª](http://www.sunnychen.top/2019/07/06/RISC-V%E5%BC%82%E5%B8%B8%E4%B8%8E%E4%B8%AD%E6%96%AD%E6%9C%BA%E5%88%B6%E6%A6%82%E8%BF%B0/)

ï¼ˆåé¢å…¶ä»–debugè¿‡ç¨‹ä¸­æŸ¥çš„èµ„æ–™å°±æ²¡æœ‰è®°å½•äº†ï¼Œspecä¹Ÿæ´¾ä¸Šäº†å¾ˆå¤§ç”¨åœº

## Code

### strap.c

```c
#include "put.h"

void put_trap_s(void) {
    static int counter = 0;
    puts("[S] Supervisor Mode Timer Interrupt ");
    puti(counter++);
    puts("\n");
    return;
}
```

### head.S

```assembly
.section .text.init

.global _start
_start:
    # init .bss
    la t0, .bss      # pointer
    la t1, bss_size  # counter
    bss_init_loop:
        sb zero, 0(t0)
        addi t0, t0, 1
        addi t1, t1, -1
        bne t1, zero, bss_init_loop

    # set mtimecmp to mtime+time_sep
    la t0, mtime_addr  # RV64, t0 is of 64 bit
    ld t1, 0(t0)       # mtime->t1
    la t0, time_sep
    add t1, t1, t0
    la t0, mtimecmp_addr
    sd t1, 0(t0)

    # set time int delegation
    li t1, 0x20  # mi[e|p][5]=sti[e|p]
    csrs mideleg, t1

    # set mstatus.mpie
    li t1, 0x80  # mstatus[7]
    csrs mstatus, t1

    # set mstatus.mie, mie.mtie, sstatus.sie, sie.stie
    li t1, 0x8   # mstatus[3]
    csrs mstatus, t1
    li t1, 0x80  # mie[7]
    csrs mie, t1
    li t1, 0x2   # sstatus[1]
    csrs sstatus, t1
    li t1, 0x20  # sie[5]
    csrs sie, t1

    # set mtvec(M mode)
    la t1, trap_m  # mode = directed
    csrw mtvec, t1

    # switch from M to S
    li t1, 0x1000  # MPP[1] = 0
    csrc mstatus, t1
    li t1, 0x800   # MPP[0] = 1
    csrs mstatus, t1

    la t1, S_Mode
    csrw mepc, t1
    mret

S_Mode:
    # set stvec(S mode)
    la t1, trap_s  # mode = directed
    csrw stvec, t1

    # set sp
    la sp, stack_top

    # jump to start_kernel in main.c
    call start_kernel

.global _end
_end:
```

### entry.S

```assembly
.section .text.entry

.global trap_m
trap_m:
    # Save regs
    addi sp, sp, -32
    sd t0, 0(sp)
    sd t1, 8(sp)
    csrr t0, mcause
    sd t0, 16(sp)
    csrr t0, mepc
    sd t0, 24(sp)

    csrr t0, mcause
    srli t1, t0, 63    # t1 = MSB
    andi t0, t0, 0xff  # t0 = code
    beq t1, zero, trap_m_except

    trap_m_int:
        la t1, mcause_MTimer
        beq t0, t1, trap_m_timer
        j trap_m_end

        trap_m_timer:
            # enable mip.stip
            li t0, 0x20   # mip[5]
            csrs mip, t0  # For trap_s

            # clear mie.mtie
            li t0, 0x80
            csrc mie, t0

            j trap_m_end

    trap_m_except:
        la t1, mcause_ecallS
        beq t0, t1, trap_m_ecallS
        j trap_m_except_end

        trap_m_ecallS:
            # !!!!!! clear mip.stip !!!!!!
            li t0, 0x20   # sip[5]
            csrc mip, t0  # Stop from calling trap_s

            # set mtimecmp += time_sep, hardware will clear mip.mtip
            la t0, mtime_addr
            ld t0, 0(t0)    # t0 = mtimecmp
            la t1, time_sep
            add t1, t0, t1  # t1 = mtimecmp+sep
            la t0, mtimecmp_addr
            sd t1, 0(t0)

            # enable mie.mtie
            li t0, 0x80
            csrs mie, t0

            j trap_m_except_end

        trap_m_except_end:
            ld t0, 24(sp)
            addi t0, t0, 4  # mepc += 4
            sd t0, 24(sp)

    trap_m_end:
    # Get regs back
    ld t0, 24(sp)
    csrw mepc, t0
    ld t0, 16(sp)
    csrw mcause, t0
    ld t1, 8(sp)
    ld t0, 0(sp)
    addi sp, sp, 32

    mret


.global trap_s
trap_s:
    # Save regs
    addi sp, sp, -40
    sd t0, 0(sp)
    sd t1, 8(sp)
    csrr t0, scause
    sd t0, 16(sp)
    csrr t0, sepc
    sd t0, 24(sp)

    csrr t0, scause
    srli t1, t0, 63    # t1 = MSB
    andi t0, t0, 0xff  # t0 = code
    beq t1, zero, trap_s_except

    trap_s_int:
        la t1, scause_STimer
        beq t0, t1, trap_s_timer
        j trap_s_end

        trap_s_timer:
            call put_trap_s
            ecall

            j trap_s_end

    trap_s_except:

        j trap_s_except_end  # No implementation yet

        trap_s_except_end:
            ld t0, 24(sp)
            addi t0, t0, 4  # sepc += 4
            sd t0, 24(sp)

    trap_s_end:
    # Get regs back
    ld t0, 24(sp)
    csrw sepc, t0
    ld t0, 16(sp)
    csrw scause, t0
    ld t1, 8(sp)
    ld t0, 0(sp)
    addi sp, sp, 40

    sret
```

### vmlinux.lds

```
OUTPUT_ARCH( "riscv" )
ENTRY( _start )
BASE_ADDR = 0x80000000;
SECTIONS
{
    . = BASE_ADDR;
    .text : {
        *(.text.init)
        *(.text.entry)
        *(.text)
        }
    .rodata : { *(.rodata) }
    .data : { *(.data) }
    .bss : { *(.bss) }
    . += 0x8000;
    stack_top = .;
    _end = .;

    bss_size = 0x100;
    mtime_addr = 0x200bff8;
    mtimecmp_addr = 0x2004000;
    time_sep = 1000000;
    mcause_MTimer = 0x7;
    mcause_ecallS = 0x9;
    scause_STimer = 0x5;
}
```

